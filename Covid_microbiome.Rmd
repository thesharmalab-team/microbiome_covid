---
title: "Covid_microbiome"
output: html_document
---

#Set up
```{r setup, include=FALSE,echo=FALSE, warning=FALSE, results='hide', message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

 # this script loads the packages and installing them if needed
source("scripts/load_packages.R")

 # this script loads the functions into the space
source("scripts/my_scripts.R")

# Loads the local curated data if the data is not there then it will download it 
source("scripts/get_curatData.R")

```

#User defined variables
```{r, include=FALSE,echo=FALSE, warning=FALSE, results='hide', message=FALSE}
# These are go point for the analysis that takes the longest
beta.go <- TRUE
siamcat.go <- TRUE
# Label prefix for PDF that are generated
#labels editing of files
output.prefix <- "output/Covid19_"
#############################################
# Filtering of the curat dataset

# All of the pseq that are ever generated are stored within the mypseq. 
mypseq <- list("raw.curat.pseq" = curat.pseq)
############################################
# define the year and the age
owid.year <-"2020"
#gbd.age <- "aged 70 or older"
# set colour theme
theme_set(theme_Sharmalab())         
# Data input
# Input the Our World in Data
# Covid data set
data_hosp <- read.csv("~/Desktop/Covid_Curat.csv")
data_hosp[1] <- NULL
# AD Range of the graphs
hosp.range <- c(3416,5984109)

#### THIS IS THE HIGH AND LOW GROUPS THAT WILL BE USED THROUGHOUT THE SCRIPT 
# loads the Our World in Data and relabels straight away. 
covid.owid <- as.data.frame(data_hosp, col_names = TRUE) %>%
  rename_all( tolower)  %>%
  dplyr::select(location, hosp_patients, aged_70_older, gdp_per_capita, human_development_index)

curatcountry.list <- c("SWE","FIN","DNK","NLD","ITA","ESP","FRA","USA","GBR","AUT", "CAN", "ISR", "SLV", "EST")

# selecting only curated countries
curatcountry <- get_variable(curat.pseq, "country" )

# this line postively selects these factors while preserving the length
curatcountry <- factor(curatcountry, levels = curatcountry.list )
sample_data(curat.pseq)$curatcountry = curatcountry

# Covid groupings
curat.low <- c("FIN","USA","CAN","DNK","AUT","EST","NLD")
curat.high <- c("ESP", "ISR", "SWE", "SLV", "GBR", "FRA", "ITA") 
# this are the countries that are dropped.
curat.drop <- c("BGD","ETH", "GHA", "HUN", "ISL", "LUX", "NOR", "SVK", "DEU", "FJI", "KAZ", "MDG", "CHN", "MNG", "PER", "RUS", "TZA", "IND")

mythres <- 1848.58

# Figure legends
disease <- "COVID-19"

# define the labels for the graphs generated
hosp.label <- "Hospitalised Patients on a given day"
grp.label <-"Disease group"
fig_title_owid_combo <- "Figure 1"
fig_title_owid_curat <- "Disease burden represented in the Curated microbiome data" 
fig_title_alpha <- "Alpha Diversity for the Curated dataset"
fig_title_beta <- "Beta Diversity for the Curated dataset"
fig_title_abudance <- 'Abundance in the disease grouping in Curated microbiome dataset'
fig_title_permanova <- "PERMANOVA"
tab_title_gbm <- paste('Burden of ', disease)
gbm_ref <- "Our World in Data Study, 2020"
```

# Main processing scripts
```{r,include=FALSE,echo=FALSE, warning=FALSE, results='hide', message=FALSE}
# no pseq used
# runs the pseq recode script 
#source("scripts/pseq_recode.R")

source("scripts/pseq_prep.R")

mypseq <- pseq_prep_1(curat.pseq,mypseq)

source("scripts/mydata_prep.R")

mydata <- mydata_prep(mypseq)
# output, curat.combined

mypseq <- pseq_filter(mypseq)

list2env(mypseq,envir=.GlobalEnv)
list2env(mydata,envir=.GlobalEnv)

```

\newpage
#Table Global Burden of Disease
```{r, message=FALSE, warning=FALSE, echo=FALSE}
# covid.owid data is the output from the country_prep.R script 
my.table.data <- covid.owid
# creates the data.frame from the OWID table based on year and age
#my.table.data <- my.table.data[my.table.data$year == gbd.year & my.table.data$age == gbd.age , ]
# removes other columns
#my.table.data <- dplyr::select (my.table.data, "Region", "location","DALY", "Prevalence", "Incidence")

# This is the place in the table that the means are inserted
#gbm.mean.levels <- c(5,13,19,22,26)

# gbm.table is a Sharmalab function. expects the levels. This produces the table in flextable format

gbm.table <- function(my.table.data) {
  ft <-arrange(my.table.data, location)
  #ft <-ft %>% dplyr::rename(Country = location) 
  # creates the means
  #ft.mean <-  summaryBy( . ~ Region, data = ft) %>%
    #add_row()
  #ft <- as_grouped_data(ft, groups = c("Region"))
  
  # Tidy's up the data and renames and then inserts a column with Total 
  #ft.mean <-ft.mean %>% 
    #dplyr::rename(DALY = DALY.mean,Prevalence = Prevalence.mean, Incidence = Incidence.mean) %>% 
   # add_column( Country = "Mean", .after = 1)
  # Intersts the rows. The number here are critical 
  #ft<- insertRows(ft, gbm.mean.levels, new = ft.mean, rcurrent = FALSE)
  # this removes the country label for the means
  #ft[gbm.mean.levels,1] <- ""
  ft <- flextable(ft) %>% 
    footnote( i = 1, j = 3:5,
              value = as_paragraph(
                c(gbm_ref)
              ),
              ref_symbols = c("a"),
              part = "header") %>% 
    colformat_num( j = 3:5, digits = 2) %>% 
    valign( valign = "bottom", part = "header") %>% 
    add_header_lines(values = c(tab_title_gbm) ) %>% 
    bold(part = "header") %>%
    #bold(i = gbm.mean.levels) %>%
    theme_booktabs() %>% 
    autofit() %>% 
    fix_border_issues()
  return(ft)
}

ft <- gbm.table(my.table.data) 
ft
```


```{r,message=FALSE, warning=FALSE, out.height= "200%" , echo=FALSE}
# plots the graphs 
#the key inputs are mydata ; curat.combined & atlas.curat.combined
#atlas.curat.combined contains the freq for the curated data set when put into Atlas labels
# these graphs do not use the pseq as such. 

# sets the font size
myfont <- 18
#remove duplicate curat.freq columns
mydata[["curat.combined"]] <- mydata[["curat.combined"]][, !duplicated(colnames(mydata[["curat.combined"]]))]

#all in the year 2020
#c1 <- ggplot(mydata[["curat.combined"]], aes(x = owid.year, y = hosp_patients, colour = location)) + 
  geom_line() + 
  ylab(label=hosp.label) + 
  xlab(NULL) + theme(legend.position="none") + 
  ylim(hosp.range) +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        text = element_text(size = myfont)) + 
  scale_color_Sharmalab(palette="curat")


##################### Creates captions #######################
temp <- mydata[["curat.combined" ]]
curat.total.sample <- sum(temp$curat.freq)

curat.total.caption <- paste('Total no. microbiome samples =', curat.total.sample)
##################### COVID #######################

c2 <- ggplot(covid.owid, aes( area=curat.freq,fill=hosp_patients, label = hosp.label )) + 
  geom_treemap() +
  scale_fill_scico(palette = "buda", limit = hosp.range)  +
  geom_treemap_text( colour = "black", place = "centre", grow = FALSE) +
  theme(legend.position="right")  + 
  labs(fill = hosp.label )

# this generates the high and label. Uses mythres which is defined above.
# Curat dataset
mydata[["curat.combined" ]]$hl.label[mydata[["curat.combined" ]]$hosp_patients >= mythres] <- "HIGH"
mydata[["curat.combined" ]]$hl.label[mydata[["curat.combined" ]]$hosp_patients < mythres] <- "LOW"
mydata[["curat.combined" ]]$hl.label <- factor(mydata[["curat.combined" ]]$hl.label)


# k means expermental code. It does work and is the data led. 
# input <- subset(atlas.curat.combined, Year==gbd.year, select = -c(Region,Year,curat.sample,hl.label,atlas.sample))
# input <- subset(atlas.curat.combined, Year==gbd.year, select = c(Prevalence))
# 
# output <- kmeans(input, centers = 2, nstart = 20)
# temp <- kmeans(temo$DALY, 2)
# temo$kmeans <- temp$cluster

ct1 <- ggplot(subset(mydata[["curat.combined" ]]), aes( area=curat.freq,fill=hl.label, label = hosp.label )) + 
  geom_treemap() + 
  scale_color_scico(palette = "vik")  +
  geom_treemap_text( colour = "black", place = "centre", grow = FALSE) + 
  theme(legend.position="bottom") + 
  labs(fill = hosp.label )

# Combines the Curat figures
figure.curat.class <- c2 + ct1, plot_layout(ncol = 2) + plot_annotation(
  title = fig_title_owid_curat,
  caption = curat.total.caption
) & theme(plot.tag = element_text(size = 14))

# Saves the figures
save_plot(paste(output.prefix, "figure.curat.class.png", sep="_"), figure.curat.class, ncol = 2,base_height = 11.69, base_width = 8.27)

# adds the graphics to the document
include_graphics(paste(output.prefix, "figure.curat.class.png", sep="_"))

```