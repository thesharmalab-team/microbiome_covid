---
title: "Covid_microbiome"
output: html_document
---

#Set up
```{r setup, include=FALSE,echo=FALSE, warning=FALSE, results='hide', message=FALSE}
knitr::opts_chunk$set(echo = TRUE)

 # this script loads the packages and installing them if needed
source("scripts_covid/load_packages.R")

 # this script loads the functions into the space
source("scripts_covid/my_scripts.R")

# Loads the local curated data if the data is not there then it will download it 
source("scripts_covid/get_curatData.R")
```

#User defined variables
```{r, include=FALSE,echo=FALSE, warning=FALSE, results='hide', message=FALSE}
# These are go point for the analysis that takes the longest
beta.go <- TRUE
siamcat.go <- TRUE
# Label prefix for PDF that are generated
#labels editing of files
output.prefix <- "output/Covid19_"
#############################################

# Filtering of the curat dataset

curat.pseq <- subset_samples(curat.pseq, disease == "healthy")
curat.pseq <- subset_samples(curat.pseq, age_category != "newborn")
#rename NAs so they don't get removed
curat.pseq@sam_data[["age"]][is.na(curat.pseq@sam_data[["age"]])] <- -1
curat.pseq <- subset_samples(curat.pseq, age != between(age, 0, 2))
#rename back to NAs
curat.pseq@sam_data[["age"]][curat.pseq@sam_data[["age"]]== -1] <- "NA"

# All of the pseq that are ever generated are stored within the mypseq. 
mypseq <- list("raw.curat.pseq" = curat.pseq)
############################################
# define the year and the age
owid.year <-"2020"
#gbd.age <- "aged 70 or older"
# set colour theme
theme_set(theme_Sharmalab())         
# Data input
# Input the Our World in Data
# Covid data set
data_hosp <- read.csv("~/Documents/Covid/Covid/Covid_Curat_pop.csv")

# AD Range of the graphs
hosp.range <- c(258.09,5621.29)

#### THIS IS THE HIGH AND LOW GROUPS THAT WILL BE USED THROUGHOUT THE SCRIPT 
# loads the Our World in Data and relabels straight away. 
covid.owid <- as.data.frame(data_hosp, col_names = TRUE) %>%
  rename_all( tolower)  %>%
  dplyr::select(location, hosp_patients, aged_70_older, gdp_per_capita, human_development_index, number_samples, population, hosp_by_pop)

curatcountry.list <- c("SWE","FIN","DNK","NLD","ITA","ESP","FRA","USA","GBR","AUT", "CAN", "ISR", "SLV", "EST")

# selecting only curated countries
curatcountry <- get_variable(curat.pseq, "country" )

# this line postively selects these factors while preserving the length
curatcountry <- factor(curatcountry, levels = curatcountry.list )
sample_data(curat.pseq)$curatcountry = curatcountry

# Covid groupings
curat.low <- c("FIN","USA","CAN","DNK","EST","NLD")
curat.high <- c("ESP", "ISR", "SWE", "GBR", "FRA", "ITA") 
# this are the countries that are dropped.
curat.drop <- c("BGD","ETH", "GHA", "HUN", "ISL", "LUX", "NOR", "SVK", "DEU", "FJI", "KAZ", "MDG", "CHN", "MNG", "PER", "RUS", "TZA", "IND")

# Dropping the other countries
country <- get_variable(curat.pseq, "country" )
country <- droplevels(factor(country), curat.drop) 
sample_data(curat.pseq)$country = country

#remove countries with NAs
curat.pseq <- subset_samples(curat.pseq, country != "NA")

mythres <- 1842.75

# Figure legends
disease <- "COVID-19"

# define the labels for the graphs generated
hosp.label <- "Hospitalised Patients per 100,000"
grp.label <-"Hospitalisation groups"
fig_title_owid_combo <- "Figure 1"
fig_title_owid_curat <- "Hospitalisation burden represented in the Curated microbiome data" 
fig_title_alpha <- "Alpha Diversity for the Curated dataset"
fig_title_beta <- "Beta Diversity for the Curated dataset"
fig_title_abudance <- 'Abundance in the hospitalisation grouping in Curated microbiome dataset'
fig_title_permanova <- "PERMANOVA"
tab_title_gbm <- paste('Burden of ', disease)
gbm_ref <- "Our World in Data Study, 2020"
```

# Main processing scripts
```{r,include=FALSE,echo=FALSE, warning=FALSE, results='hide', message=FALSE}
# no pseq used
# runs the pseq recode script 
#source("scripts/pseq_recode.R")

source("scripts_covid/pseq_prep.R")

mypseq <- pseq_prep_1(curat.pseq,mypseq)
#source("scripts_covid/mydata_prep.R")

mydata <- mydata_prep(mypseq)
# output, curat.combined

mypseq <- pseq_filter(mypseq)

list2env(mypseq,envir=.GlobalEnv)
list2env(mydata,envir=.GlobalEnv)

```

\newpage
#Table Global Burden of Disease
```{r, message=FALSE, warning=FALSE, echo=FALSE}
# covid.owid data is the output from the country_prep.R script 
my.table.data <- covid.owid
# creates the data.frame from the OWID table based on year and age
#my.table.data <- my.table.data[my.table.data$year == gbd.year & my.table.data$age == gbd.age , ]
# removes other columns
#my.table.data <- dplyr::select (my.table.data, "Region", "location","DALY", "Prevalence", "Incidence")

# This is the place in the table that the means are inserted
#gbm.mean.levels <- c(5,13,19,22,26)

# gbm.table is a Sharmalab function. expects the levels. This produces the table in flextable format

ft <- gbm.table(my.table.data) 
ft
```


```{r,message=FALSE, warning=FALSE, out.height= "200%" , echo=FALSE}
# plots the graphs 
#the key inputs are mydata ; curat.combined & atlas.curat.combined
#atlas.curat.combined contains the freq for the curated data set when put into Atlas labels
# these graphs do not use the pseq as such. 

# sets the font size
myfont <- 18
#remove duplicate curat.freq columns
mydata[["curat.combined"]] <- mydata[["curat.combined"]][, !duplicated(colnames(mydata[["curat.combined"]]))]

##################### Creates captions #######################
temp <- mydata[["curat.combined" ]]
curat.total.sample <- sum(temp$curat.freq)

curat.total.caption <- paste('Total no. microbiome samples =', curat.total.sample)
##################### COVID #######################

c2 <- ggplot(covid.owid, aes( area=curat.freq,fill=hosp_by_pop, label = location )) + 
  geom_treemap() +
  scale_fill_scico(palette = "buda", limit = hosp.range)  +
  geom_treemap_text( colour = "black", place = "centre", grow = FALSE) +
  theme(legend.position="right")  + 
  labs(fill = hosp.label )

# this generates the high and label. Uses mythres which is defined above.
# Curat dataset
mydata[["curat.combined" ]]$hl.label[mydata[["curat.combined" ]]$hosp_by_pop >= mythres] <- "HIGH"
mydata[["curat.combined" ]]$hl.label[mydata[["curat.combined" ]]$hosp_by_pop < mythres] <- "LOW"
mydata[["curat.combined" ]]$hl.label <- factor(mydata[["curat.combined" ]]$hl.label)


# k means expermental code. It does work and is the data led. 
# input <- subset(atlas.curat.combined, Year==gbd.year, select = -c(Region,Year,curat.sample,hl.label,atlas.sample))
# input <- subset(atlas.curat.combined, Year==gbd.year, select = c(Prevalence))
# 
# output <- kmeans(input, centers = 2, nstart = 20)
# temp <- kmeans(temo$DALY, 2)
# temo$kmeans <- temp$cluster

ct1 <- ggplot(subset(mydata[["curat.combined" ]]), aes( area=curat.freq,fill=hl.label, label = location )) + 
  geom_treemap() + 
  scale_color_scico(palette = "vik")  +
  geom_treemap_text( colour = "black", place = "centre", grow = FALSE) + 
  theme(legend.position="bottom") + 
  labs(fill = hosp.label )

# Combines the Curat figures
figure.curat.class <- c2 + ct1 + plot_layout(ncol = 2) + plot_annotation(
  title = fig_title_owid_curat,
  caption = curat.total.caption
) & theme(plot.tag = element_text(size = 14))

# Saves the figures
save_plot(paste(output.prefix, "figure.curat.class.png", sep="_"), figure.curat.class, ncol = 2,base_height = 11.69, base_width = 8.27)

# adds the graphics to the document
include_graphics(paste(output.prefix, "figure.curat.class.png", sep="_"))

```

# Demographic data
\newpage
```{r, results="asis" }

#source("scripts_covid/my_cur_table.R")
source("scripts_covid/pseq_recode.R")
# Generates the table. This is a Sharmalab function
###########
  
  #curat.pseq <- subset_samples(mypseq[["curat.recode.country.pseq"]], curat.covid.class == "HIGH" | curat.covid.class == "LOW")
    
  # defines the length of the new frame
  n <- length(sample_data(curat.pseq)$curat.covid.class)
  message(paste(c("The total number of microbiome samples:", n), collapse = " "))
  data <- data.frame(id=1:n)
  
  # get the disease classification. 
  data$curat.covid.class <- sample_data(curat.pseq)$curat.covid.class
  # brings in the co-variates
  data$bmi <- sample_data(curat.pseq)$bmi_group
  # replace the NA with unknown
  data$bmi_group <- fct_explicit_na(data$bmi, na_level = "Unknown")

  data$bmi <- factor(data$bmi, levels = c("lean",
                                          "overweight",
                                        "obese",
                                          "morbid obese",
                                         "severe obese",
                                          "super obese",
                                          "Unknown"))
  
  data$bmi <- mapvalues(data$bmi, 
                        from = c("lean", 
                                 "overweight",
                                 "obese", 
                                 "morbid obese", 
                                "severe obese",
                                 "super obese",
                                 "Unknown"),
                       to = c("Lean (BMI 18.5+ to 25)",
                              "Overweight (BMI 25+ to 30)",
                               "Obese (BMI 30+ to 35)", 
                              "Morbid obese (BMI 35+ to 40)",
                               "Severe Obese (BMI 40+ to 45)", 
                               "Super Obese (BMI 45+)",
                               "Unknown"))
  # Age
  data$age_category <- sample_data(curat.pseq)$age_category
  data$age_category <- data$age_category  %>% replace_na("Unknown")
  
  # stats for age:
  # for whole dataset
  a <- summary(data$age)
  b <- sd(data$age,na.rm=T)
  # by group
  c <- aggregate(. ~ curat.covid.class, data, function(x) c(mean = mean(x), sd = sd(x)))
  # print
  message(paste(c("The summary statistics for age are", capture.output(a), " The SD is", b, "Per group, it is", capture.output(c)), collapse = "\n"))
  
  # Gender
  data$gender <- sample_data(curat.pseq)$gender
  # replace the NA with unknown
  data$gender <- fct_explicit_na(data$gender, na_level = "Unknown")
  
  #table1(~ age  +  bmi | curat.mnd.class, data=data)   
  #table_one <- tableby(curat.mnd.class ~ bmi + age, data = data)
  t1 <- data %>%  set_labels(list(bmi = "BMI", age_category = "Age Group", gender = "Gender")) %>% 
    tableby(curat.covid.class ~ gender + age_category + bmi, data = .,
            test=FALSE,
            numeric.stats=c( "mean","sd"),
            cat.stats=c("count"), 
            digits=2 ) %>%
    as.data.frame() %>% dplyr::select(.,
                               -group.term,
                               -group.label,
                               -strata.term,
                               -term,
                               -variable.type,
                               -variable) %>%
    dplyr::rename(., "Variable" = label, "Low Disease Group" = LOW, "High Disease group" = HIGH)
#  t1[c(1,8),2] <- ""
#  t1 <- as_grouped_data(t1, groups = c("variable"))
  t1 <- flextable(t1) %>% 
    add_header_lines(values = c("Demographic Data: Curat Dataset") ) %>% 
    bold(part = "header") %>%
    bold(i = c(1,4,9)) %>%
    theme_booktabs() %>% 
    autofit() %>% 
    fix_border_issues()
t1

###########

```

# Alpha Diversity
```{r, message=FALSE, warning=FALSE, out.height= "200%" , echo=FALSE}

# CURAT  Generates the meta data
curat.meta <- alpha_d_curat(mypseq[["curat.recode.country.comp.filter.pseq"]])

# CURAT generates the country alpha diversity. The number in the palettes must equal the number of groups in bmi.pairs
alpha.p1.curat <-ggviolin(curat.meta, x = "country", y = "Shannon",
                  add = "boxplot", fill = "country") +
    theme(axis.text.x = element_blank(),axis.ticks = element_blank()) + 
    theme(legend.position="bottom",legend.title = element_blank()) + 
    xlab("") + 
  scale_fill_Sharmalab(palette="curat")  

# CURAT high and low graphs   
alpha.p2.curat <- ggviolin(data=subset(curat.meta, !is.na(curat.covid.class)), x = "curat.covid.class", y = "Shannon", add = "boxplot", fill = "curat.covid.class", na.rm = TRUE)  + 
  scale_fill_Sharmalab(palette="two_group_curat")  

# adds the stats  
alpha.p2.curat <<- alpha.p2.curat + stat_compare_means(comparisons = covid.pairs) + 
    xlab("Covid Hospitalisations") + 
    theme(legend.position="bottom", axis.text.x = element_blank(),axis.ticks = element_blank()) +
    guides(fill=guide_legend(title="Covid Hospitalisations"))

# Combines the graphs to the final figure
fig.alpha.curat.group <- alpha.p1.curat + alpha.p2.curat +
  plot_layout(guides = 'collect') + plot_annotation(tag_levels = 'A',
  title = fig_title_alpha ,
  subtitle = 'Individual Countries and resulting Disease Group') & theme(legend.position = 'bottom')

# Saves the output
save_plot(paste(output.prefix, "figure.alpha.group.png", sep="_"), fig.alpha.curat.group, ncol = 2, base_height = 11.69, base_width = 8.2)  

# Include sthe graphic
include_graphics(paste(output.prefix, "figure.alpha.group.png", sep="_"))
```

# Abundance Graph
```{r,message=FALSE, warning=FALSE, out.height= "200%" , echo=FALSE}

# CURATED Get the Phylum
curat.pseq.comp.filter.phylum <- aggregate_taxa(mypseq[["curat.recode.country.comp.filter.pseq"]], "Phylum")

# CURAT plot
curated.barplot  <- plot_composition(curat.pseq.comp.filter.phylum, average_by = "curat.covid.class", x.label = "Disease Grouping", plot.type = "barplot", title = "Curated Abundance Bar Plot") + 
  guides(fill=guide_legend(title="Phylum")) + 
  theme(legend.text = element_text(face="italic")) + 
  theme_classic() + 
  labs(x="Disease Grouping") + 
  theme(legend.title = element_text(size = 10), legend.text = element_text(size = 10)) + 
  scale_x_discrete(labels=c("LOW" = "Low","HIGH" = "High")) + 
  scale_fill_brewer(palette = "Paired") 

# Abundance Profile
curat.pseq.comp.filter.phylum2 <- phyloseq::tax_glom(mypseq[["curat.recode.country.comp.filter.pseq"]], "Phylum")

phyloseq::taxa_names(curat.pseq.comp.filter.phylum2) <- phyloseq::tax_table(curat.pseq.comp.filter.phylum2)[, "Phylum"]

phyloseq::otu_table(curat.pseq.comp.filter.phylum2)[1:5, 1:5]


curat.abund <- phyloseq::psmelt(curat.pseq.comp.filter.phylum2) %>%
ggplot(data = ., aes(x = curat.covid.class , y = Abundance)) +
  geom_boxplot(outlier.shape  = NA) +
  geom_jitter(aes(color = OTU), height = 0, width = .2) +
  labs(x = "", y = "Abundance\n") +
  facet_wrap(~ OTU, scales = "free")

p.abdunace <- curated.barplot + curat.abund + plot_annotation(tag_levels = 'A',
  title = fig_title_abudance) 

save_plot(paste(output.prefix, "figure.abdunace.png", sep="_"), p.abdunace, ncol = 2, base_height = 11.69, base_width = 8.2) 

include_graphics(paste(output.prefix, "figure.abdunace.png", sep="_"))
```

#Beta Diversity
```{r}

#Remember that curat.recode.country.pseq is already relative abundance 
devtools::install_github("vmikk/metagMisc")
library(metagMisc)
beta_curat <- mypseq[["curat.recode.country.pseq" ]] %>%
  phyloseq_rm_na_tax() %>% # removes the strain that is empty
  subset_taxa(!is.na(Genus)) %>% # Keeps the Species only
  prune_samples(sample_sums(.) >= 10, .) %>%# removes abudance that are less than 10
  subset_samples( !is.na(curat.covid.class)) # removes the NA

#ordinated_taxa = ordinate(t7, method="NMDS", distance="bray")

ordinated_taxa = ordinate(beta_curat, method="PCoA", distance="bray")

p <- plot_ordination(beta_curat, ordinated_taxa, color="curat.covid.class", 
                title = "Bray-Curtis Principal Coordinates Analysis")

#p1 < - plot_scree(ordinated_taxa, title="Screeplot")

#plot_net(beta_curat, "bray", color = "curat.covid.class")

save_plot(paste(output.prefix, "figure.beta.png", sep="_"), p, ncol = 2, base_height = 11.69, base_width = 8.2) 

include_graphics(paste(output.prefix, "figure.beta.png", sep="_"))
```

#PERMANOVA
```{r}
source("scripts_covid/perma_d_two.R")
# this function uses the entire list. 
mypermanova <- perma_d_two(mypseq)

# Seperates the datasets
permanova.curat <- mypermanova[["permanova.curat"]]

  p1 <- ggplot(permanova.curat,aes(reorder(label, top.coef),top.coef,fill = top.coef > 0)) +
    geom_col(show.legend = FALSE,) + 
    coord_flip() +  
    theme(label = element_text(face = "bold.italic", color = "blue", size = 16)) + 
    xlab('Taxa') + ylab('p value')  + 
    theme_minimal(base_size = 20)  + 
    annotate("text", x = 2.5, y = 0.02, label = "Harmful Taxa") + 
    annotate("text", x = 19, y = -0.01, label = "Beneficial Taxa") +
    md_theme_minimal() #This is required for the Italics 
  
  fig.permanova.group <- p1 +
    plot_annotation(tag_levels = 'A',
    title = fig_title_permanova ,
    subtitle = 'Curat data') 

save_plot(paste(output.prefix, "figure.permanova.group.png", sep="_"), fig.permanova.group, ncol = 1, base_height = 11.69, base_width = 8.2)  

include_graphics(paste(output.prefix, "figure.permanova.group.png", sep="_"))

```

#  SIAMCAT 
```{r}

#create the curat label
label.curat <- create.label(meta=sample_data(mypseq[["curat.recode.country.comp.pseq" ]]),
                      label = "curat.covid.class",
                      case = c("HIGH"), control = "LOW")

# Create SIAMCAT object
siamcat.curat <- siamcat(phyloseq=mypseq[["curat.recode.country.comp.pseq" ]], label=label.curat)

# Feature Filtering
siamcat.curat <- filter.features(siamcat.curat, 
                           cutoff=1e-04, 
                           filter.method = 'abundance', 
                           feature.type = 'original')

```

#SIAMCAT Curated
```{r}

if (  TRUE == siamcat.go ) {

# Association Testing  "RdYlBu"  "#00B0FF", "#FFD740" + "#EC407A", "#00B0FF"
check.associations(siamcat.curat, 
                   fn.plot=paste(output.prefix, "figure.SIAMCAT.ckassn.curat.pdf", sep="_"), 
                   color.scheme =c("#FFCE53", "#4FC1E9"),
                   alpha =0.05, 
                   mult.corr = "fdr", 
                   sort.by = "fc",
                   detect.lim = 1e-06, 
                   pr.cutoff = 1e-6, 
                   max.show = 40,
                   plot.type = "quantile.box",
                   panels = c("fc","auroc"), 
                   prompt = TRUE,
                   feature.type = 'filtered', 
                   verbose = 1)

include_graphics(paste(output.prefix, "figure.SIAMCAT.ckassn.curat.pdf", sep="_"))

check.confounders(siamcat.curat,
                  fn.plot = paste(output.prefix, "figure.SIAMCAT.ckconfd.curat.pdf", sep="_"),
                  meta.in = c("curat.covid.class", "sex", "age_category", "bmi_group"))

include_graphics(paste(output.prefix, "figure.SIAMCAT.ckconfd.curat.pdf", sep="_"))

# Only run this the once. It will take a long time. It requires siamcat input. 
#siamcat_modelbuilder(siamcat)

#Only run this if the model builder is NOT being ran
siamcat.curat <- normalize.features(
  siamcat.curat,
  norm.method = "log.unit",
  norm.param = list(
    log.n0 = 1e-06,
    n.p = 2,
    norm.margin = 1
  )
)
# Only run this if the model builder is NOT being ran
siamcat.curat <-  create.data.split(
  siamcat.curat,
  num.folds = 10,
  num.resample = 10
)

# This is the choosen model
siamcat.curat <- train.model(
  siamcat.curat,
  method = "ridge"
)
siamcat.curat <- make.predictions(siamcat.curat)
siamcat.curat <- evaluate.predictions(siamcat.curat)

model.evaluation.plot(siamcat.curat, fn.plot = paste(output.prefix, "figure.SIAMCAT.eval.plot.curat.pdf", sep="_"))

include_graphics(paste(output.prefix, "figure.SIAMCAT.eval.plot.curat.pdf", sep="_"))

#siamcat.ridge
model.interpretation.plot(
  siamcat.curat, 
  fn.plot = paste(output.prefix, "figure.SIAMCAT.intrp.curat.pdf", sep="_"),
  color.scheme = "BrBG",
  consens.thres = 0.5,
  heatmap.type = "zscore",
  limits = c(-3, 3), detect.lim = 1e-09,
  max.show = 40, prompt=TRUE, verbose = 1)

include_graphics(paste(output.prefix, "figure.SIAMCAT.intrp.curat.pdf", sep="_"))

} else {
   message("Not performing SIAMCAT ")
}

```